import { VerticalBox, HorizontalBox, Button, TextEdit, CheckBox } from "std-widgets.slint";

component ToolTipArea {
    in property <string> text;
    callback clicked <=> ta.clicked;

    ta := TouchArea { }

    // The actual content (your CheckBox will go here)
    @children

    // Tooltip popup
    if ta.has-hover: Rectangle {
        background: #333;
        border-radius: 4px;
        x: ta.mouse-x + 10px;
        y: ta.mouse-y + 10px;
        z: 100;

        Text {
            text: root.text;
            color: white;
            font-size: 12px;
            x: 6px;
            y: 4px;
        }

        // A little padding
        width: tooltip_text.width + 12px;
        height: tooltip_text.height + 8px;

        tooltip_text := Text {
            text: root.text;
            color: white;
            font-size: 12px;
            x: 6px;
            y: 4px;
        }
    }
}

export component AppWindow inherits Window {
    title: "Gua KLine Viewer";
    width: 1000px;
    height: 800px;

    in-out property <image> svg-image;
    in-out property <string> current-scale: "Scale: 1.0x";
    in-out property <length> image-x-offset: 0px;
    in-out property <length> target-x-offset: 0px;
    in-out property <string> svg-status: "Ready";

    // KLine query inputs (parsed in Rust)
    in-out property <string> market-input: "0";
    in-out property <string> code-input: "000001";
    in-out property <string> category-input: "9";
    in-out property <string> start-input: "0";
    in-out property <string> count-input: "100";
    in-out property <bool> full-render: false;

    callback reload-kline();

    callback scale-up();
    callback scale-down();
    callback reset-scale();
    callback swipe-left();
    callback swipe-right();
    callback kline-click(x: length, y: length, view-w: length, view-h: length);
    callback move-cursor-by(delta: int);

    // Animation for smooth position changes
    animate target-x-offset {
        duration: 300ms;
        easing: ease-out;
    }

    VerticalBox {
        // padding: 20px;
        padding-left: 20px;
        padding-right: 20px;
        spacing: 15px;

        // Text {
        //     text: "Gua KLine Viewer";
        //     font-size: 20px;
        //     font-weight: 600;
        //     horizontal-alignment: center;
        // }

        // KLine Query Section
        VerticalBox {
            spacing: 8px;

            Text {
                text: "KLine query:";
                font-size: 14px;
                font-weight: 500;
            }

            // Row 1: market + code
            HorizontalBox {
                spacing: 20px;

                Text {
                    text: "market (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 38px;
                    text <=> root.market-input;
                    placeholder-text: "0";
                }

                Text {
                    text: "code";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 120px;
                    height: 38px;
                    text <=> root.code-input;
                    placeholder-text: "000001";
                }

                Text {
                    text: "category (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 38px;
                    text <=> root.category-input;
                    placeholder-text: "9";
                }
            }

            // Row 2: category + start + count + render mode + reload
            HorizontalBox {
                spacing: 20px;

                // Text {
                //     text: "category (u16)";
                //     font-size: 12px;
                //     vertical-alignment: center;
                // }

                // TextEdit {
                //     width: 80px;
                //     height: 30px;
                //     text <=> root.category-input;
                //     placeholder-text: "9";
                // }

                Text {
                    text: "start (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 38px;
                    text <=> root.start-input;
                    placeholder-text: "0";
                }

                Text {
                    text: "count (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 38px;
                    text <=> root.count-input;
                    placeholder-text: "100";
                }

                ToolTipArea {
                    text: "Show volume + grid + labels";
                    CheckBox {
                        text: "Full render";
                        checked <=> root.full-render;
                    }
                }

                Button {
                    text: "Reload / Refresh";
                    primary: true;
                    clicked => {
                        root.reload-kline();
                    }
                }

                Button {
                    text: "Reset View";
                    clicked => {
                        root.reset-scale();
                    }
                }
            }

            HorizontalBox {
                spacing: 20px;
                alignment: center;

                Text {
                    text: root.current-scale;
                    font-size: 14px;
                    color: #666;
                }

                Text {
                    text: root.svg-status;
                    font-size: 12px;
                    color: #666;
                }
            }
        }

        // Image Display Area
        Rectangle {
            border-radius: 8px;
            border-width: 0px;
            border-color: #ddd;
            background: #f9f9f9;
            min-height: 300px;
            clip: true;

            chart-focus := FocusScope {
                // anchors.fill: parent;
                // Replace anchors.fill: parent; with:
                width: parent.width;
                height: parent.height;
                focus-on-click: true;

                key-pressed(event) => {
                    if (event.text == Key.LeftArrow) {
                        if (event.modifiers.meta || event.modifiers.shift || event.modifiers.control) {
                            root.move-cursor-by(-10);
                        } else {
                            root.move-cursor-by(-1);
                        }
                        return accept;
                    }
                    if (event.text == Key.RightArrow) {
                        if (event.modifiers.meta || event.modifiers.shift || event.modifiers.control) {
                            // ⌘ + →
                            root.move-cursor-by(10);
                        } else {
                            // →
                            root.move-cursor-by(1);
                        }
                        return accept;
                    }
                    if (event.text == Key.UpArrow) {
                        root.scale-up();
                        return accept;
                    }
                    if (event.text == Key.DownArrow) {
                        root.scale-down();
                        return accept;
                    }
                    return reject;
                }

            // Touch area for swipe detection
            touch-area := TouchArea {
                    property <length> start-x;
                    property <length> start-y;
                    property <bool> is-swiping: false;
                    property <bool> moved-far: false;

                    moved => {
                        if (self.pressed && self.is-swiping) {
                        // mark as moved if the pointer travels more than a few pixels (avoid treating drags as clicks)
                        if (self.mouse-x - self.start-x > 5px || self.start-x - self.mouse-x > 5px || self.mouse-y - self.start-y > 5px || self.start-y - self.mouse-y > 5px) {
                                self.moved-far = true;
                            }
                            if (self.mouse-x - self.start-x > 50px) {
                                root.swipe-right();
                                self.is-swiping = false;
                            } else if (self.start-x - self.mouse-x > 50px) {
                                root.swipe-left();
                                self.is-swiping = false;
                            }
                        }
                    }

                    pointer-event(event) => {
                        if (event.kind == PointerEventKind.down) {
                            chart-focus.focus();
                            self.start-x = self.pressed-x;
                            self.start-y = self.pressed-y;
                            self.is-swiping = true;
                            self.moved-far = false;
                        } else if (event.kind == PointerEventKind.up) {
                            if (self.is-swiping && !self.moved-far) {
                            // click/tap: reposition the cursor to nearest kline
                            // root.kline-click(self.pressed-x, self.pressed-y, self.width, self.height);
                            root.kline-click(self.mouse-x, self.mouse-y, self.width, self.height);
                            }
                            self.is-swiping = false;
                            self.moved-far = false;
                        }
                    }
                }

                // Image container with animated position
            Rectangle {
                    x: root.target-x-offset;
                    width: parent.width;
                    height: parent.height;

                    Image {
                        source: root.svg-image;
                        image-fit: contain;
                    }
                }

                // Floating control pad in bottom right
            Rectangle {
                    x: parent.width - 144px;
                    y: parent.height - 144px;
                    width: 124px;
                    height: 124px;

                    // Scale Up Button (Top)
                Rectangle {
                        x: 42px;
                        y: 0px;
                        width: 40px;
                        height: 40px;
                        border-radius: 20px;
                        background: #4dabf7;
                        border-width: 1px;
                        border-color: #339af0;

                        TouchArea {
                            clicked => {
                                root.scale-up();
                            }
                        }

                        Text {
                            text: "+";
                            font-size: 18px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Swipe Left Button (Left)
                Rectangle {
                        x: 0px;
                        y: 42px;
                        width: 40px;
                        height: 40px;
                        border-radius: 20px;
                        background: #a8e6cf;
                        border-width: 1px;
                        border-color: #88d8a3;

                        TouchArea {
                            clicked => {
                                root.swipe-left();
                            }
                        }

                        Text {
                            text: "←";
                            font-size: 16px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Reset Button (Center)
                Rectangle {
                        x: 42px;
                        y: 42px;
                        width: 40px;
                        height: 40px;
                        border-radius: 20px;
                        background: #4ecdc4;
                        border-width: 1px;
                        border-color: #45b7b8;

                        TouchArea {
                            clicked => {
                                root.reset-scale();
                            }
                        }

                        Text {
                            text: "↻";
                            font-size: 16px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Swipe Right Button (Right)
                Rectangle {
                        x: 84px;
                        y: 42px;
                        width: 40px;
                        height: 40px;
                        border-radius: 20px;
                        background: #ffd93d;
                        border-width: 1px;
                        border-color: #ffcc02;

                        TouchArea {
                            clicked => {
                                root.swipe-right();
                            }
                        }

                        Text {
                            text: "→";
                            font-size: 16px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Scale Down Button (Bottom)
                Rectangle {
                        x: 42px;
                        y: 84px;
                        width: 40px;
                        height: 40px;
                        border-radius: 20px;
                        background: #ff6b6b;
                        border-width: 1px;
                        border-color: #e85555;

                        TouchArea {
                            clicked => {
                                root.scale-down();
                            }
                        }

                        Text {
                            text: "−";
                            font-size: 20px;
                            font-weight: 600;
                            color: white;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}
