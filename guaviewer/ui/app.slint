import { VerticalBox, HorizontalBox, Button, TextEdit, ScrollView, CheckBox } from "std-widgets.slint";


component ToolTipArea {
    in property <string> text;
    callback clicked <=> ta.clicked;

    ta := TouchArea { }

    // The actual content (your CheckBox will go here)
    @children

    // The Tooltip popup
    if ta.has-hover: Rectangle {
        background: #333;
        border-radius: 4px;
        x: ta.mouse-x + 10px;
        y: ta.mouse-y + 10px;
        z: 100; // Ensure it stays on top

        Text {
            text: root.text;
            color: white;
            // padding: 4px;
        }
    }
}

export component AppWindow inherits Window {
    title: "SVG Viewer with Custom Input";
    width: 1000px;
    height: 900px;

    in-out property <image> svg-image;
    in-out property <string> current-scale: "Scale: 1.0x";
    in-out property <length> image-x-offset: 0px;
    in-out property <length> target-x-offset: 0px;
    in-out property <string> svg-input;
    in-out property <string> svg-status: "Ready";

    // KLine query inputs (these are parsed in Rust)
    in-out property <string> market-input: "0";
    in-out property <string> code-input: "000001";
    in-out property <string> category-input: "9";
    in-out property <string> start-input: "0";
    in-out property <string> count-input: "1";
    in-out property <bool> full-render: false;

    callback reload-kline();

    callback scale-up();
    callback scale-down();
    callback reset-scale();
    callback swipe-left();
    callback swipe-right();
    callback svg-content-changed();

    // Animation for smooth position changes
    animate target-x-offset {
        duration: 300ms;
        easing: ease-out;
    }

    VerticalBox {
        padding: 20px;
        spacing: 15px;

        Text {
            text: "SVG Viewer with Custom Input";
            font-size: 20px;
            font-weight: 600;
            horizontal-alignment: center;
        }

        // KLine Query Section
        VerticalBox {
            spacing: 8px;

            Text {
                text: "KLine query:";
                font-size: 14px;
                font-weight: 500;
            }

            // Row 1: market + code
            HorizontalBox {
                spacing: 10px;

                Text {
                    text: "market (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 30px;
                    text <=> root.market-input;
                    placeholder-text: "0";
                }

                Text {
                    text: "code";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 120px;
                    height: 30px;
                    text <=> root.code-input;
                    placeholder-text: "000001";
                }
            }

            // Row 2: category + start + count + render mode + reload
            HorizontalBox {
                spacing: 10px;

                Text {
                    text: "category (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 30px;
                    text <=> root.category-input;
                    placeholder-text: "9";
                }

                Text {
                    text: "start (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 30px;
                    text <=> root.start-input;
                    placeholder-text: "0";
                }

                Text {
                    text: "count (u16)";
                    font-size: 12px;
                    vertical-alignment: center;
                }

                TextEdit {
                    width: 80px;
                    height: 30px;
                    text <=> root.count-input;
                    placeholder-text: "1";
                }

                ToolTipArea {
                    text: "Show volume + grid + labels";
                    CheckBox {
                        text: "Full render";
                        checked <=> root.full-render;
                        // tooltip: "Show volume + grid + labels";
                    }
                }

                Button {
                    text: "Reload / Refresh";
                    primary: true;
                    clicked => {
                        root.reload-kline();
                    }
                }
            }
        }

        // SVG Input Section
        VerticalBox {
            spacing: 10px;

            Text {
                text: "SVG Content:";
                font-size: 14px;
                font-weight: 500;
            }

            VerticalBox {
                spacing: 8px;

                Text {
                    text: "SVG Content - Edit directly in the text area below:";
                    font-size: 12px;
                    font-weight: 500;
                    color: #333;
                }

                // Editable text area using TextEdit
                Rectangle {
                    height: 160px;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #ccc;
                    background: white;

                    TextEdit {
                        text <=> root.svg-input;
                        font-size: 11px;
                        wrap: word-wrap;
                        read-only: false;
                        x: 5px;
                        y: 5px;
                        width: parent.width - 10px;
                        height: parent.height - 10px;
                    }
                }
            }

            HorizontalBox {
                spacing: 10px;

                Button {
                    text: "Update SVG";
                    primary: true;
                    clicked => {
                        root.svg-content-changed();
                    }
                }

                Button {
                    text: "Reset View";
                    clicked => {
                        root.reset-scale();
                    }
                }

                Text {
                    text: root.svg-status;
                    font-size: 12px;
                    color: #666;
                    vertical-alignment: center;
                }
            }
        }

        // Scale and Status
        HorizontalBox {
            spacing: 20px;
            alignment: center;

            Text {
                text: root.current-scale;
                font-size: 14px;
                color: #666;
            }
        }

        // Image Display Area
        Rectangle {
            border-radius: 8px;
            border-width: 2px;
            border-color: #ddd;
            background: #f9f9f9;
            min-height: 300px;
            clip: true; // Enable clipping to hide overflowing content

            // Touch area for swipe detection
            touch-area := TouchArea {
                property <length> start-x;
                property <bool> is-swiping: false;

                clicked => {
                    // Record start position when pressed
                    if (!self.is-swiping) {
                        self.start-x = self.pressed-x;
                        self.is-swiping = true;
                    }
                }

                moved => {
                    if (self.pressed && self.is-swiping) {
                        // Calculate swipe distance using mouse-x (current position)
                        if (self.mouse-x - self.start-x > 50px) {
                            // Swipe right
                            root.swipe-right();
                            self.is-swiping = false;
                        } else if (self.start-x - self.mouse-x > 50px) {
                            // Swipe left
                            root.swipe-left();
                            self.is-swiping = false;
                        }
                    }
                }

                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down) {
                        self.start-x = self.pressed-x;
                        self.is-swiping = true;
                    } else if (event.kind == PointerEventKind.up) {
                        self.is-swiping = false;
                    }
                }
            }

            // Image container with animated position
            Rectangle {
                x: root.target-x-offset;
                width: parent.width;
                height: parent.height;

                Image {
                    source: root.svg-image;
                    image-fit: contain;
                }
            }

            // Floating control pad in bottom right
            Rectangle {
                x: parent.width - 144px;
                y: parent.height - 144px;
                width: 124px;
                height: 124px;

                // Scale Up Button (Top)
                Rectangle {
                    x: 42px;
                    y: 0px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: #4dabf7;
                    border-width: 1px;
                    border-color: #339af0;

                    TouchArea {
                        clicked => {
                            root.scale-up();
                        }
                    }

                    Text {
                        text: "+";
                        font-size: 18px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Swipe Left Button (Left)
                Rectangle {
                    x: 0px;
                    y: 42px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: #a8e6cf;
                    border-width: 1px;
                    border-color: #88d8a3;

                    TouchArea {
                        clicked => {
                            root.swipe-left();
                        }
                    }

                    Text {
                        text: "←";
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Reset Button (Center)
                Rectangle {
                    x: 42px;
                    y: 42px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: #4ecdc4;
                    border-width: 1px;
                    border-color: #45b7b8;

                    TouchArea {
                        clicked => {
                            root.reset-scale();
                        }
                    }

                    Text {
                        text: "↻";
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Swipe Right Button (Right)
                Rectangle {
                    x: 84px;
                    y: 42px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: #ffd93d;
                    border-width: 1px;
                    border-color: #ffcc02;

                    TouchArea {
                        clicked => {
                            root.swipe-right();
                        }
                    }

                    Text {
                        text: "→";
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                // Scale Down Button (Bottom)
                Rectangle {
                    x: 42px;
                    y: 84px;
                    width: 40px;
                    height: 40px;
                    border-radius: 20px;
                    background: #ff6b6b;
                    border-width: 1px;
                    border-color: #e85555;

                    TouchArea {
                        clicked => {
                            root.scale-down();
                        }
                    }

                    Text {
                        text: "−";
                        font-size: 20px;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }

        Text {
            text: "Edit SVG content in the text area above. Changes update automatically every 0.5 seconds or use 'Update SVG'.";
            font-size: 12px;
            horizontal-alignment: center;
            color: #888;
        }
    }
}
